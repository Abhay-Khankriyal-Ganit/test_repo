- name: Create or Update Glue Jobs
  run: |
    S3_PATH="s3://${S3_BUCKET}/${SCRIPT_PREFIX}${RUN_ID}/"
    for JOB_FILE in glue_jobs/*.py; do
      JOB_NAME=$(basename "$JOB_FILE" .py)
      SCRIPT_S3_PATH="${S3_PATH}${JOB_NAME}.py"
      echo "Processing Glue job: $JOB_NAME"
 
      # Prepare valid job-config.json (JSON content starts at column 0)
      cat <<EOL > job-config.json
{
  "Name": "${JOB_NAME}",
  "Role": "${GLUE_ROLE_ARN}",
  "Command": {
    "Name": "glueetl",
    "ScriptLocation": "${SCRIPT_S3_PATH}",
    "PythonVersion": "3"
  },
  "MaxRetries": 0,
  "GlueVersion": "3.0",
  "NumberOfWorkers": 2,
  "WorkerType": "Standard"
}
EOL
 
      # Create or update Glue job
      if aws glue get-job --job-name "$JOB_NAME" >/dev/null 2>&1; then
        echo "Updating Glue job: $JOB_NAME"
        aws glue update-job --job-name "$JOB_NAME" --job-update file://job-config.json
      else
        echo "Creating Glue job: $JOB_NAME"
        aws glue create-job --cli-input-json file://job-config.json
      fi
    done
